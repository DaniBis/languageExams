"use strict";(()=>{var e={};e.id=225,e.ids=[225],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},665:e=>{e.exports=require("dns")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},6582:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g});var o={};r.r(o),r.d(o,{GET:()=>d,POST:()=>c});var i=r(9303),n=r(8716),s=r(670),a=r(7070),u=r(8827),l=r(6119);async function d(e){let{searchParams:t}=new URL(e.url),r=t.get("start")??void 0,o=t.get("days"),i=o?Number(o):void 0,n=Number.isNaN(i??NaN)?void 0:i,s=await (0,u.C9)({startDate:r,days:n});return a.NextResponse.json({slots:s})}async function c(e){try{let{name:t,email:r,note:o,slotIds:i,bookingType:n}=await e.json();if(!t||!r||!i?.length||!n?.trim())return a.NextResponse.json({error:"Missing required information."},{status:400});let s=await (0,u.CB)(i,{name:t,email:r,note:o,bookingType:n});try{await (0,l.c)({name:t,email:r,note:o,bookingType:n,slots:s.map(e=>({start:e.start,end:e.end}))})}catch(e){console.error("Email notification failed",e)}return a.NextResponse.json({success:!0,slots:s})}catch(e){return console.error("Booking error",e),a.NextResponse.json({error:e.message},{status:400})}}let p=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/schedule/route",pathname:"/api/schedule",filename:"route",bundlePath:"app/api/schedule/route"},resolvedPagePath:"/Users/ovidiuban/languageExams/app/api/schedule/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:w}=p,f="/api/schedule/route";function h(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},6119:(e,t,r)=>{r.d(t,{c:()=>n,r:()=>s});var o=r(5245);function i(e,t=!1){let r=process.env[e];if(t&&!r)throw Error(`${e} is not configured.`);return r}async function n(e){let t=i("SMTP_HOST",!0),r=Number(i("SMTP_PORT",!0)),n=i("SMTP_USER",!0),s=i("SMTP_PASS",!0),a=i("BOOKING_NOTIFICATION_TO")||i("CONTACT_EMAIL_TO",!0),u=o.createTransport({host:t,port:r,secure:465===r,auth:{user:n,pass:s}}),l=e.slots.map(e=>`• ${new Date(e.start).toUTCString()} → ${new Date(e.end).toUTCString()}`).join("\n"),d=["New booking received",`Name: ${e.name}`,`Email: ${e.email}`,`Booking: ${e.bookingType}`,`Slots:
${l}`];e.note&&d.push(`Note: ${e.note}`),await u.sendMail({from:`Booking Bot <${n}>`,to:a,subject:`New booking from ${e.name} – ${e.bookingType}`,text:d.join("\n\n")})}async function s(e){let t=i("SMTP_HOST",!0),r=Number(i("SMTP_PORT",!0)),n=i("SMTP_USER",!0),s=i("SMTP_PASS",!0),a=i("CONTACT_EMAIL_TO",!0),u=o.createTransport({host:t,port:r,secure:465===r,auth:{user:n,pass:s}});await u.sendMail({from:`Website Contact <${n}>`,to:a,replyTo:e.email,subject:`[Contact] ${e.subject}`,text:[`Name: ${e.name}`,`Email: ${e.email}`,"",e.message].join("\n")})}},8827:(e,t,r)=>{r.d(t,{C9:()=>d,CB:()=>p,Yj:()=>m,aL:()=>c,hy:()=>g});var o=r(2048),i=r(5315),n=r.n(i);let s=n().join(process.cwd(),"data","schedule.json");async function a(){await o.promises.mkdir(n().dirname(s),{recursive:!0});try{await o.promises.access(s)}catch{await o.promises.writeFile(s,"[]","utf8")}}async function u(){await a();let e=await o.promises.readFile(s,"utf8"),t=e.trim()?JSON.parse(e):[];return Array.isArray(t)?t.map(e=>({...e,entryType:"admin-lock"===e.entryType?"admin-lock":"user"})):[]}async function l(e){await a(),await o.promises.writeFile(s,JSON.stringify(e,null,2),"utf8")}async function d({startDate:e,days:t}={}){let r=new Map((await u()).map(e=>[e.id,e])),o=e?new Date(e):new Date;return Number.isNaN(o.getTime())&&(o=new Date),(function(e,t){let r=[];for(let o=0;o<t;o++){let t=new Date(e);t.setUTCDate(e.getUTCDate()+o);for(let e=7;e<22;e++)for(let o=0;o<60;o+=30){let i=new Date(t);i.setUTCHours(e,o,0,0);let n=new Date(i);n.setUTCMinutes(i.getUTCMinutes()+30),r.push({id:i.toISOString(),start:i.toISOString(),end:n.toISOString(),status:"available"})}}return r})(function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t}(o),Math.min(Math.max(t??7,1),31)).map(e=>{let t=r.get(e.id);if(!t)return e;let o="admin-lock"===t.entryType?"locked":"booked";return{...e,status:o}})}async function c(){return u()}async function p(e,{name:t,email:r,note:o,bookingType:i}){if(!e.length)throw Error("No slot ids provided.");let n=await u(),s=new Map(n.map(e=>[e.id,e])),a=[];for(let u of e){if(s.has(u))throw Error("One or more slots have just been booked by another student.");let e=new Date(u);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let l=e.getUTCHours();if(l<7||l>=22)throw Error("Slot is outside of bookable hours.");let d=new Date(e);d.setUTCMinutes(e.getUTCMinutes()+30);let c={id:u,start:e.toISOString(),end:d.toISOString(),bookedByName:t,bookedByEmail:r,bookingType:i?.trim()||void 0,note:o,bookedAt:new Date().toISOString(),entryType:"user"};n.push(c),s.set(u,c),a.push({id:u,start:c.start,end:c.end,status:"booked"})}return await l(n),a}async function m(e,{note:t,adminLabel:r}={}){if(!e.length)throw Error("No slot ids provided for locking.");let o=await u(),i=new Map(o.map(e=>[e.id,e]));for(let n of e){if(i.has(n))throw Error("One or more selected slots are already booked or locked.");let e=new Date(n);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected for locking.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let s=e.getUTCHours();if(s<7||s>=22)throw Error("Slot is outside of bookable hours.");let a=new Date(e);a.setUTCMinutes(e.getUTCMinutes()+30);let u={id:n,start:e.toISOString(),end:a.toISOString(),bookedByName:r||"Admin Hold",bookedByEmail:"admin@englishwithdaniel.com",bookingType:t?.trim()||void 0,bookedAt:new Date().toISOString(),entryType:"admin-lock"};o.push(u),i.set(n,u)}await l(o)}async function g(e){if(!e.length)throw Error("No slot ids provided for unlocking.");let t=await u(),r=new Set(e),o=t.filter(e=>!("admin-lock"===e.entryType&&r.has(e.id)));await l(o)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[276,972,245],()=>r(6582));module.exports=o})();