"use strict";(()=>{var e={};e.id=225,e.ids=[225],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},665:e=>{e.exports=require("dns")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},6582:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>w});var i={};r.r(i),r.d(i,{GET:()=>c,POST:()=>d});var o=r(9303),n=r(8716),a=r(670),s=r(7070),u=r(9882),l=r(6119);async function c(e){let{searchParams:t}=new URL(e.url),r=t.get("start")??void 0,i=t.get("days"),o=i?Number(i):void 0,n=Number.isNaN(o??NaN)?void 0:o,a=await (0,u.C9)({startDate:r,days:n});return s.NextResponse.json({slots:a})}async function d(e){try{let{name:t,email:r,note:i,slotIds:o,bookingType:n}=await e.json();if(!t||!r||!o?.length||!n?.trim())return s.NextResponse.json({error:"Missing required information."},{status:400});let a=await (0,u.CB)(o,{name:t,email:r,note:i,bookingType:n});try{await (0,l.c)({name:t,email:r,note:i,bookingType:n,slots:a.map(e=>({start:e.start,end:e.end}))})}catch(e){console.error("Email notification failed",e)}return s.NextResponse.json({success:!0,slots:a})}catch(e){return console.error("Booking error",e),s.NextResponse.json({error:e.message},{status:400})}}let p=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/schedule/route",pathname:"/api/schedule",filename:"route",bundlePath:"app/api/schedule/route"},resolvedPagePath:"/Users/ovidiuban/languageExams/app/api/schedule/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:w,serverHooks:f}=p,y="/api/schedule/route";function g(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:w})}},6119:(e,t,r)=>{r.d(t,{c:()=>n,r:()=>a});var i=r(5245);function o(e,t=!1){let r=process.env[e];if(t&&!r)throw Error(`${e} is not configured.`);return r}async function n(e){let t=o("SMTP_HOST",!0),r=Number(o("SMTP_PORT",!0)),n=o("SMTP_USER",!0),a=o("SMTP_PASS",!0),s=o("BOOKING_NOTIFICATION_TO")||o("CONTACT_EMAIL_TO",!0),u=i.createTransport({host:t,port:r,secure:465===r,auth:{user:n,pass:a}}),l=e.slots.map(e=>`• ${new Date(e.start).toUTCString()} → ${new Date(e.end).toUTCString()}`).join("\n"),c=["New booking received",`Name: ${e.name}`,`Email: ${e.email}`,`Booking: ${e.bookingType}`,`Slots:
${l}`];e.note&&c.push(`Note: ${e.note}`),await u.sendMail({from:`Booking Bot <${n}>`,to:s,subject:`New booking from ${e.name} – ${e.bookingType}`,text:c.join("\n\n")})}async function a(e){let t=o("SMTP_HOST",!0),r=Number(o("SMTP_PORT",!0)),n=o("SMTP_USER",!0),a=o("SMTP_PASS",!0),s=o("CONTACT_EMAIL_TO",!0),u=i.createTransport({host:t,port:r,secure:465===r,auth:{user:n,pass:a}});await u.sendMail({from:`Website Contact <${n}>`,to:s,replyTo:e.email,subject:`[Contact] ${e.subject}`,text:[`Name: ${e.name}`,`Email: ${e.email}`,"",e.message].join("\n")})}},9882:(e,t,r)=>{r.d(t,{vL:()=>_,CB:()=>E,aL:()=>b,G7:()=>C,C9:()=>k,Yj:()=>v,U6:()=>O,hy:()=>M});var i=r(2048),o=r(5315),n=r.n(o),a=r(7786);let s=n().join(process.cwd(),"data","schedule.json"),u=n().join(process.cwd(),"data","recurring-locks.json"),l=function(){if(!(process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN||process.env.KV_REST_API_URL&&process.env.KV_REST_API_TOKEN))return null;try{return a.s.fromEnv()}catch(e){return console.error("Failed to initialize KV client. Falling back to filesystem storage.",e),null}}(),c=process.env.SCHEDULE_KV_BOOKINGS_KEY??"schedule:bookings",d=process.env.SCHEDULE_KV_RECURRING_KEY??"schedule:recurring-locks";async function p(){await i.promises.mkdir(n().dirname(s),{recursive:!0});try{await i.promises.access(s)}catch{await i.promises.writeFile(s,"[]","utf8")}}async function m(){await i.promises.mkdir(n().dirname(u),{recursive:!0});try{await i.promises.access(u)}catch{await i.promises.writeFile(u,"[]","utf8")}}function w(e){return"object"==typeof e&&null!==e&&"DYNAMIC_SERVER_USAGE"===e.digest}async function f(e){if(!l)return null;try{let t=await l.get(e);if(!t)return null;return t}catch(t){return w(t)||console.error(`KV read failed for ${e}`,t),null}}async function y(e,t){if(!l)return!1;try{return await l.set(e,t),!0}catch(t){return w(t)||console.error(`KV write failed for ${e}`,t),!1}}async function g(){let e=await f(c)??await (async()=>{await p();let e=await i.promises.readFile(s,"utf8");return e.trim()?JSON.parse(e):[]})(),t=Array.isArray(e)?e:[];return Array.isArray(t)?t.map(e=>({...e,entryType:"admin-lock"===e.entryType?"admin-lock":"user"})):[]}async function h(e){await y(c,e)||(await p(),await i.promises.writeFile(s,JSON.stringify(e,null,2),"utf8"))}async function T(){let e=await f(d)??await (async()=>{await m();let e=await i.promises.readFile(u,"utf8");return e.trim()?JSON.parse(e):[]})(),t=Array.isArray(e)?e:[];return Array.isArray(t)?t.map(e=>({id:String(e.id),weekday:Number(e.weekday),startMinutes:Number(e.startMinutes),durationMinutes:Number(e.durationMinutes),note:e.note?String(e.note):void 0})).filter(e=>!Number.isNaN(e.weekday)&&!Number.isNaN(e.startMinutes)&&!Number.isNaN(e.durationMinutes)):[]}async function S(e){await y(d,e)||(await m(),await i.promises.writeFile(u,JSON.stringify(e,null,2),"utf8"))}function N(e,t){if(e.getUTCDay()!==t.weekday)return!1;let r=60*e.getUTCHours()+e.getUTCMinutes();return r>=t.startMinutes&&r<t.startMinutes+t.durationMinutes}async function k({startDate:e,days:t}={}){let r=new Map((await g()).map(e=>[e.id,e])),i=await T(),o=e?new Date(e):new Date;return Number.isNaN(o.getTime())&&(o=new Date),(function(e,t){let r=[];for(let i=0;i<t;i++){let t=new Date(e);t.setUTCDate(e.getUTCDate()+i);for(let e=7;e<22;e++)for(let i=0;i<60;i+=30){let o=new Date(t);o.setUTCHours(e,i,0,0);let n=new Date(o);n.setUTCMinutes(o.getUTCMinutes()+30),r.push({id:o.toISOString(),start:o.toISOString(),end:n.toISOString(),status:"available"})}}return r})(function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t}(o),Math.min(Math.max(t??7,1),31)).map(e=>{let t=r.get(e.id);if(t){let r="admin-lock"===t.entryType?"locked":"booked";return{...e,status:r,lockType:"admin-lock"===t.entryType?"manual":void 0,lockNote:"admin-lock"===t.entryType?t.bookingType:void 0}}let o=new Date(e.start),n=i.find(e=>N(o,e));return n?{...e,status:"locked",lockType:"recurring",lockNote:n.note,recurringLockId:n.id}:e})}async function b(){return g()}async function E(e,{name:t,email:r,note:i,bookingType:o}){if(!e.length)throw Error("No slot ids provided.");let n=await g(),a=new Map(n.map(e=>[e.id,e])),s=await T(),u=[];for(let l of e){if(a.has(l))throw Error("One or more slots have just been booked by another student.");let e=new Date(l);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let c=e.getUTCHours();if(c<7||c>=22)throw Error("Slot is outside of bookable hours.");if(function(e,t){return t.some(t=>N(e,t))}(e,s))throw Error("This slot is blocked by the tutor. Please pick another time.");let d=new Date(e);d.setUTCMinutes(e.getUTCMinutes()+30);let p={id:l,start:e.toISOString(),end:d.toISOString(),bookedByName:t,bookedByEmail:r,bookingType:o?.trim()||void 0,note:i,bookedAt:new Date().toISOString(),entryType:"user"};n.push(p),a.set(l,p),u.push({id:l,start:p.start,end:p.end,status:"booked"})}return await h(n),u}async function v(e,{note:t,adminLabel:r}={}){if(!e.length)throw Error("No slot ids provided for locking.");let i=await g(),o=new Map(i.map(e=>[e.id,e]));for(let n of e){if(o.has(n))throw Error("One or more selected slots are already booked or locked.");let e=new Date(n);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected for locking.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let a=e.getUTCHours();if(a<7||a>=22)throw Error("Slot is outside of bookable hours.");let s=new Date(e);s.setUTCMinutes(e.getUTCMinutes()+30);let u={id:n,start:e.toISOString(),end:s.toISOString(),bookedByName:r||"Admin Hold",bookedByEmail:"admin@englishwithdaniel.com",bookingType:t?.trim()||void 0,bookedAt:new Date().toISOString(),entryType:"admin-lock"};i.push(u),o.set(n,u)}await h(i)}async function M(e){if(!e.length)throw Error("No slot ids provided for unlocking.");let t=await g(),r=new Set(e),i=t.filter(e=>!("admin-lock"===e.entryType&&r.has(e.id)));await h(i)}async function C(){return T()}async function _(e){let{weekday:t,startMinutes:r,durationMinutes:i,note:o}=e;if(!Number.isInteger(t)||t<0||t>6)throw Error("Weekday must be between 0 (Sunday) and 6 (Saturday).");if(r%30!=0)throw Error("Start time must align with the 30-minute grid.");if(i<30||i%30!=0)throw Error("Duration must be in 30-minute increments.");if(r<420||r>=1320)throw Error("Start time is outside of bookable hours.");if(r+i>1320)throw Error("Recurring lock exceeds the bookable day range.");let n=await T(),a={id:`${t}-${r}-${Date.now()}`,weekday:t,startMinutes:r,durationMinutes:i,note:o?.trim()||void 0};return n.push(a),await S(n),n}async function O(e){let t=(await T()).filter(t=>t.id!==e);return await S(t),t}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[276,786,972,245],()=>r(6582));module.exports=i})();