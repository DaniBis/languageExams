"use strict";(()=>{var e={};e.id=647,e.ids=[647],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6005:e=>{e.exports=require("node:crypto")},8591:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>w,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p});var n={};r.r(n),r.d(n,{POST:()=>l});var i=r(9303),o=r(8716),s=r(670),a=r(7070),u=r(9882);async function l(e){try{if(!function(e){let t=process.env.SCHEDULE_ADMIN_KEY;if(!t)throw Error("SCHEDULE_ADMIN_KEY is not configured.");return(e.headers.get("x-admin-key")||e.nextUrl.searchParams.get("key"))===t}(e))return a.NextResponse.json({error:"Unauthorized."},{status:401});let t=await e.json(),{action:r}=t;if(!r)return a.NextResponse.json({error:"Missing action."},{status:400});if("lock"===r||"unlock"===r){let{slotIds:e,note:n}=t;if(!Array.isArray(e)||!e.length)return a.NextResponse.json({error:"Missing slot ids."},{status:400});return"lock"===r?await (0,u.Yj)(e,{note:n}):await (0,u.hy)(e),a.NextResponse.json({success:!0})}if("add-recurring"===r){let{weekday:e,startMinutes:r,durationMinutes:n,note:i}=t;if("number"!=typeof e||"number"!=typeof r||"number"!=typeof n)return a.NextResponse.json({error:"Missing recurring lock parameters."},{status:400});let o=await (0,u.vL)({weekday:e,startMinutes:r,durationMinutes:n,note:i});return a.NextResponse.json({success:!0,recurringLocks:o})}if("remove-recurring"===r){let{recurringLockId:e}=t;if(!e)return a.NextResponse.json({error:"Missing recurring lock id."},{status:400});let r=await (0,u.U6)(e);return a.NextResponse.json({success:!0,recurringLocks:r})}if("list-recurring"===r){let e=await (0,u.G7)();return a.NextResponse.json({success:!0,recurringLocks:e})}return a.NextResponse.json({error:"Invalid action."},{status:400})}catch(e){if("SCHEDULE_ADMIN_KEY is not configured."===e.message)return a.NextResponse.json({error:e.message},{status:500});return console.error("Admin schedule update failed",e),a.NextResponse.json({error:e.message},{status:400})}}let c=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/schedule/route",pathname:"/api/admin/schedule",filename:"route",bundlePath:"app/api/admin/schedule/route"},resolvedPagePath:"/Users/ovidiuban/languageExams/app/api/admin/schedule/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:f}=c,m="/api/admin/schedule/route";function w(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}},9882:(e,t,r)=>{r.d(t,{vL:()=>D,CB:()=>T,aL:()=>b,G7:()=>M,C9:()=>E,Yj:()=>v,U6:()=>x,hy:()=>U});var n=r(2048),i=r(5315),o=r.n(i),s=r(7786);let a=o().join(process.cwd(),"data","schedule.json"),u=o().join(process.cwd(),"data","recurring-locks.json"),l=function(){if(!(process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN||process.env.KV_REST_API_URL&&process.env.KV_REST_API_TOKEN))return null;try{return s.s.fromEnv()}catch(e){return console.error("Failed to initialize KV client. Falling back to filesystem storage.",e),null}}(),c=process.env.SCHEDULE_KV_BOOKINGS_KEY??"schedule:bookings",d=process.env.SCHEDULE_KV_RECURRING_KEY??"schedule:recurring-locks";async function p(){await n.promises.mkdir(o().dirname(a),{recursive:!0});try{await n.promises.access(a)}catch{await n.promises.writeFile(a,"[]","utf8")}}async function f(){await n.promises.mkdir(o().dirname(u),{recursive:!0});try{await n.promises.access(u)}catch{await n.promises.writeFile(u,"[]","utf8")}}function m(e){return"object"==typeof e&&null!==e&&"DYNAMIC_SERVER_USAGE"===e.digest}async function w(e){if(!l)return null;try{let t=await l.get(e);if(!t)return null;return t}catch(t){return m(t)||console.error(`KV read failed for ${e}`,t),null}}async function y(e,t){if(!l)return!1;try{return await l.set(e,t),!0}catch(t){return m(t)||console.error(`KV write failed for ${e}`,t),!1}}async function g(){let e=await w(c)??await (async()=>{await p();let e=await n.promises.readFile(a,"utf8");return e.trim()?JSON.parse(e):[]})(),t=Array.isArray(e)?e:[];return Array.isArray(t)?t.map(e=>({...e,entryType:"admin-lock"===e.entryType?"admin-lock":"user"})):[]}async function h(e){await y(c,e)||(await p(),await n.promises.writeFile(a,JSON.stringify(e,null,2),"utf8"))}async function k(){let e=await w(d)??await (async()=>{await f();let e=await n.promises.readFile(u,"utf8");return e.trim()?JSON.parse(e):[]})(),t=Array.isArray(e)?e:[];return Array.isArray(t)?t.map(e=>({id:String(e.id),weekday:Number(e.weekday),startMinutes:Number(e.startMinutes),durationMinutes:Number(e.durationMinutes),note:e.note?String(e.note):void 0})).filter(e=>!Number.isNaN(e.weekday)&&!Number.isNaN(e.startMinutes)&&!Number.isNaN(e.durationMinutes)):[]}async function S(e){await y(d,e)||(await f(),await n.promises.writeFile(u,JSON.stringify(e,null,2),"utf8"))}function N(e,t){if(e.getUTCDay()!==t.weekday)return!1;let r=60*e.getUTCHours()+e.getUTCMinutes();return r>=t.startMinutes&&r<t.startMinutes+t.durationMinutes}async function E({startDate:e,days:t}={}){let r=new Map((await g()).map(e=>[e.id,e])),n=await k(),i=e?new Date(e):new Date;return Number.isNaN(i.getTime())&&(i=new Date),(function(e,t){let r=[];for(let n=0;n<t;n++){let t=new Date(e);t.setUTCDate(e.getUTCDate()+n);for(let e=7;e<22;e++)for(let n=0;n<60;n+=30){let i=new Date(t);i.setUTCHours(e,n,0,0);let o=new Date(i);o.setUTCMinutes(i.getUTCMinutes()+30),r.push({id:i.toISOString(),start:i.toISOString(),end:o.toISOString(),status:"available"})}}return r})(function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t}(i),Math.min(Math.max(t??7,1),31)).map(e=>{let t=r.get(e.id);if(t){let r="admin-lock"===t.entryType?"locked":"booked";return{...e,status:r,lockType:"admin-lock"===t.entryType?"manual":void 0,lockNote:"admin-lock"===t.entryType?t.bookingType:void 0}}let i=new Date(e.start),o=n.find(e=>N(i,e));return o?{...e,status:"locked",lockType:"recurring",lockNote:o.note,recurringLockId:o.id}:e})}async function b(){return g()}async function T(e,{name:t,email:r,note:n,bookingType:i}){if(!e.length)throw Error("No slot ids provided.");let o=await g(),s=new Map(o.map(e=>[e.id,e])),a=await k(),u=[];for(let l of e){if(s.has(l))throw Error("One or more slots have just been booked by another student.");let e=new Date(l);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let c=e.getUTCHours();if(c<7||c>=22)throw Error("Slot is outside of bookable hours.");if(function(e,t){return t.some(t=>N(e,t))}(e,a))throw Error("This slot is blocked by the tutor. Please pick another time.");let d=new Date(e);d.setUTCMinutes(e.getUTCMinutes()+30);let p={id:l,start:e.toISOString(),end:d.toISOString(),bookedByName:t,bookedByEmail:r,bookingType:i?.trim()||void 0,note:n,bookedAt:new Date().toISOString(),entryType:"user"};o.push(p),s.set(l,p),u.push({id:l,start:p.start,end:p.end,status:"booked"})}return await h(o),u}async function v(e,{note:t,adminLabel:r}={}){if(!e.length)throw Error("No slot ids provided for locking.");let n=await g(),i=new Map(n.map(e=>[e.id,e]));for(let o of e){if(i.has(o))throw Error("One or more selected slots are already booked or locked.");let e=new Date(o);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected for locking.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let s=e.getUTCHours();if(s<7||s>=22)throw Error("Slot is outside of bookable hours.");let a=new Date(e);a.setUTCMinutes(e.getUTCMinutes()+30);let u={id:o,start:e.toISOString(),end:a.toISOString(),bookedByName:r||"Admin Hold",bookedByEmail:"admin@englishwithdaniel.com",bookingType:t?.trim()||void 0,bookedAt:new Date().toISOString(),entryType:"admin-lock"};n.push(u),i.set(o,u)}await h(n)}async function U(e){if(!e.length)throw Error("No slot ids provided for unlocking.");let t=await g(),r=new Set(e),n=t.filter(e=>!("admin-lock"===e.entryType&&r.has(e.id)));await h(n)}async function M(){return k()}async function D(e){let{weekday:t,startMinutes:r,durationMinutes:n,note:i}=e;if(!Number.isInteger(t)||t<0||t>6)throw Error("Weekday must be between 0 (Sunday) and 6 (Saturday).");if(r%30!=0)throw Error("Start time must align with the 30-minute grid.");if(n<30||n%30!=0)throw Error("Duration must be in 30-minute increments.");if(r<420||r>=1320)throw Error("Start time is outside of bookable hours.");if(r+n>1320)throw Error("Recurring lock exceeds the bookable day range.");let o=await k(),s={id:`${t}-${r}-${Date.now()}`,weekday:t,startMinutes:r,durationMinutes:n,note:i?.trim()||void 0};return o.push(s),await S(o),o}async function x(e){let t=(await k()).filter(t=>t.id!==e);return await S(t),t}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,786,972],()=>r(8591));module.exports=n})();