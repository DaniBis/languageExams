"use strict";(()=>{var e={};e.id=647,e.ids=[647],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},8591:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var o={};r.r(o),r.d(o,{POST:()=>d});var n=r(9303),i=r(8716),s=r(670),a=r(7070),u=r(8827);async function d(e){try{if(!function(e){let t=process.env.SCHEDULE_ADMIN_KEY;if(!t)throw Error("SCHEDULE_ADMIN_KEY is not configured.");return(e.headers.get("x-admin-key")||e.nextUrl.searchParams.get("key"))===t}(e))return a.NextResponse.json({error:"Unauthorized."},{status:401});let{action:t,slotIds:r,note:o}=await e.json();if(!t||!Array.isArray(r)||!r.length)return a.NextResponse.json({error:"Missing action or slot ids."},{status:400});if("lock"===t)await (0,u.Yj)(r,{note:o});else{if("unlock"!==t)return a.NextResponse.json({error:"Invalid action."},{status:400});await (0,u.hy)(r)}return a.NextResponse.json({success:!0})}catch(e){if("SCHEDULE_ADMIN_KEY is not configured."===e.message)return a.NextResponse.json({error:e.message},{status:500});return console.error("Admin schedule update failed",e),a.NextResponse.json({error:e.message},{status:400})}}let l=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/schedule/route",pathname:"/api/admin/schedule",filename:"route",bundlePath:"app/api/admin/schedule/route"},resolvedPagePath:"/Users/ovidiuban/languageExams/app/api/admin/schedule/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:m}=l,h="/api/admin/schedule/route";function f(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}},8827:(e,t,r)=>{r.d(t,{C9:()=>l,CB:()=>p,Yj:()=>m,aL:()=>c,hy:()=>h});var o=r(2048),n=r(5315),i=r.n(n);let s=i().join(process.cwd(),"data","schedule.json");async function a(){await o.promises.mkdir(i().dirname(s),{recursive:!0});try{await o.promises.access(s)}catch{await o.promises.writeFile(s,"[]","utf8")}}async function u(){await a();let e=await o.promises.readFile(s,"utf8"),t=e.trim()?JSON.parse(e):[];return Array.isArray(t)?t.map(e=>({...e,entryType:"admin-lock"===e.entryType?"admin-lock":"user"})):[]}async function d(e){await a(),await o.promises.writeFile(s,JSON.stringify(e,null,2),"utf8")}async function l({startDate:e,days:t}={}){let r=new Map((await u()).map(e=>[e.id,e])),o=e?new Date(e):new Date;return Number.isNaN(o.getTime())&&(o=new Date),(function(e,t){let r=[];for(let o=0;o<t;o++){let t=new Date(e);t.setUTCDate(e.getUTCDate()+o);for(let e=7;e<22;e++)for(let o=0;o<60;o+=30){let n=new Date(t);n.setUTCHours(e,o,0,0);let i=new Date(n);i.setUTCMinutes(n.getUTCMinutes()+30),r.push({id:n.toISOString(),start:n.toISOString(),end:i.toISOString(),status:"available"})}}return r})(function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t}(o),Math.min(Math.max(t??7,1),31)).map(e=>{let t=r.get(e.id);if(!t)return e;let o="admin-lock"===t.entryType?"locked":"booked";return{...e,status:o}})}async function c(){return u()}async function p(e,{name:t,email:r,note:o,bookingType:n}){if(!e.length)throw Error("No slot ids provided.");let i=await u(),s=new Map(i.map(e=>[e.id,e])),a=[];for(let u of e){if(s.has(u))throw Error("One or more slots have just been booked by another student.");let e=new Date(u);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let d=e.getUTCHours();if(d<7||d>=22)throw Error("Slot is outside of bookable hours.");let l=new Date(e);l.setUTCMinutes(e.getUTCMinutes()+30);let c={id:u,start:e.toISOString(),end:l.toISOString(),bookedByName:t,bookedByEmail:r,bookingType:n?.trim()||void 0,note:o,bookedAt:new Date().toISOString(),entryType:"user"};i.push(c),s.set(u,c),a.push({id:u,start:c.start,end:c.end,status:"booked"})}return await d(i),a}async function m(e,{note:t,adminLabel:r}={}){if(!e.length)throw Error("No slot ids provided for locking.");let o=await u(),n=new Map(o.map(e=>[e.id,e]));for(let i of e){if(n.has(i))throw Error("One or more selected slots are already booked or locked.");let e=new Date(i);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected for locking.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let s=e.getUTCHours();if(s<7||s>=22)throw Error("Slot is outside of bookable hours.");let a=new Date(e);a.setUTCMinutes(e.getUTCMinutes()+30);let u={id:i,start:e.toISOString(),end:a.toISOString(),bookedByName:r||"Admin Hold",bookedByEmail:"admin@englishwithdaniel.com",bookingType:t?.trim()||void 0,bookedAt:new Date().toISOString(),entryType:"admin-lock"};o.push(u),n.set(i,u)}await d(o)}async function h(e){if(!e.length)throw Error("No slot ids provided for unlocking.");let t=await u(),r=new Set(e),o=t.filter(e=>!("admin-lock"===e.entryType&&r.has(e.id)));await d(o)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[276,972],()=>r(8591));module.exports=o})();