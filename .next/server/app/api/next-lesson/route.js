"use strict";(()=>{var e={};e.id=228,e.ids=[228],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6005:e=>{e.exports=require("node:crypto")},7238:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>f,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>w,staticGenerationAsyncStorage:()=>p});var n={};r.r(n),r.d(n,{GET:()=>l});var i=r(9303),o=r(8716),a=r(670),s=r(7070),u=r(9882);async function l(){try{let e=await (0,u.aL)(),t=Date.now(),r=e.filter(e=>"admin-lock"!==e.entryType).filter(e=>new Date(e.start).getTime()>t).sort((e,t)=>new Date(e.start).getTime()-new Date(t.start).getTime())[0];if(!r)return s.NextResponse.json({nextLesson:null});return s.NextResponse.json({nextLesson:{start:r.start,end:r.end,studentName:r.bookedByName,bookingType:r.bookingType||null}})}catch(e){return console.error("Failed to load next lesson",e),s.NextResponse.json({error:"Failed to load next lesson"},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/next-lesson/route",pathname:"/api/next-lesson",filename:"route",bundlePath:"app/api/next-lesson/route"},resolvedPagePath:"/Users/ovidiuban/languageExams/app/api/next-lesson/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:w}=d,m="/api/next-lesson/route";function f(){return(0,a.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:p})}},9882:(e,t,r)=>{r.d(t,{vL:()=>x,CB:()=>E,aL:()=>N,G7:()=>U,C9:()=>b,Yj:()=>v,U6:()=>M,hy:()=>D});var n=r(2048),i=r(5315),o=r.n(i),a=r(7786);let s=o().join(process.cwd(),"data","schedule.json"),u=o().join(process.cwd(),"data","recurring-locks.json"),l=function(){if(!(process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN||process.env.KV_REST_API_URL&&process.env.KV_REST_API_TOKEN))return null;try{return a.s.fromEnv()}catch(e){return console.error("Failed to initialize KV client. Falling back to filesystem storage.",e),null}}(),d=process.env.SCHEDULE_KV_BOOKINGS_KEY??"schedule:bookings",c=process.env.SCHEDULE_KV_RECURRING_KEY??"schedule:recurring-locks";async function p(){await n.promises.mkdir(o().dirname(s),{recursive:!0});try{await n.promises.access(s)}catch{await n.promises.writeFile(s,"[]","utf8")}}async function w(){await n.promises.mkdir(o().dirname(u),{recursive:!0});try{await n.promises.access(u)}catch{await n.promises.writeFile(u,"[]","utf8")}}function m(e){return"object"==typeof e&&null!==e&&"DYNAMIC_SERVER_USAGE"===e.digest}async function f(e){if(!l)return null;try{let t=await l.get(e);if(!t)return null;return t}catch(t){return m(t)||console.error(`KV read failed for ${e}`,t),null}}async function y(e,t){if(!l)return!1;try{return await l.set(e,t),!0}catch(t){return m(t)||console.error(`KV write failed for ${e}`,t),!1}}async function g(){let e=await f(d)??await (async()=>{await p();let e=await n.promises.readFile(s,"utf8");return e.trim()?JSON.parse(e):[]})(),t=Array.isArray(e)?e:[];return Array.isArray(t)?t.map(e=>({...e,entryType:"admin-lock"===e.entryType?"admin-lock":"user"})):[]}async function h(e){await y(d,e)||(await p(),await n.promises.writeFile(s,JSON.stringify(e,null,2),"utf8"))}async function k(){let e=await f(c)??await (async()=>{await w();let e=await n.promises.readFile(u,"utf8");return e.trim()?JSON.parse(e):[]})(),t=Array.isArray(e)?e:[];return Array.isArray(t)?t.map(e=>({id:String(e.id),weekday:Number(e.weekday),startMinutes:Number(e.startMinutes),durationMinutes:Number(e.durationMinutes),note:e.note?String(e.note):void 0})).filter(e=>!Number.isNaN(e.weekday)&&!Number.isNaN(e.startMinutes)&&!Number.isNaN(e.durationMinutes)):[]}async function S(e){await y(c,e)||(await w(),await n.promises.writeFile(u,JSON.stringify(e,null,2),"utf8"))}function T(e,t){if(e.getUTCDay()!==t.weekday)return!1;let r=60*e.getUTCHours()+e.getUTCMinutes();return r>=t.startMinutes&&r<t.startMinutes+t.durationMinutes}async function b({startDate:e,days:t}={}){let r=new Map((await g()).map(e=>[e.id,e])),n=await k(),i=e?new Date(e):new Date;return Number.isNaN(i.getTime())&&(i=new Date),(function(e,t){let r=[];for(let n=0;n<t;n++){let t=new Date(e);t.setUTCDate(e.getUTCDate()+n);for(let e=7;e<22;e++)for(let n=0;n<60;n+=30){let i=new Date(t);i.setUTCHours(e,n,0,0);let o=new Date(i);o.setUTCMinutes(i.getUTCMinutes()+30),r.push({id:i.toISOString(),start:i.toISOString(),end:o.toISOString(),status:"available"})}}return r})(function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t}(i),Math.min(Math.max(t??7,1),31)).map(e=>{let t=r.get(e.id);if(t){let r="admin-lock"===t.entryType?"locked":"booked";return{...e,status:r,lockType:"admin-lock"===t.entryType?"manual":void 0,lockNote:"admin-lock"===t.entryType?t.bookingType:void 0}}let i=new Date(e.start),o=n.find(e=>T(i,e));return o?{...e,status:"locked",lockType:"recurring",lockNote:o.note,recurringLockId:o.id}:e})}async function N(){return g()}async function E(e,{name:t,email:r,note:n,bookingType:i}){if(!e.length)throw Error("No slot ids provided.");let o=await g(),a=new Map(o.map(e=>[e.id,e])),s=await k(),u=[];for(let l of e){if(a.has(l))throw Error("One or more slots have just been booked by another student.");let e=new Date(l);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let d=e.getUTCHours();if(d<7||d>=22)throw Error("Slot is outside of bookable hours.");if(function(e,t){return t.some(t=>T(e,t))}(e,s))throw Error("This slot is blocked by the tutor. Please pick another time.");let c=new Date(e);c.setUTCMinutes(e.getUTCMinutes()+30);let p={id:l,start:e.toISOString(),end:c.toISOString(),bookedByName:t,bookedByEmail:r,bookingType:i?.trim()||void 0,note:n,bookedAt:new Date().toISOString(),entryType:"user"};o.push(p),a.set(l,p),u.push({id:l,start:p.start,end:p.end,status:"booked"})}return await h(o),u}async function v(e,{note:t,adminLabel:r}={}){if(!e.length)throw Error("No slot ids provided for locking.");let n=await g(),i=new Map(n.map(e=>[e.id,e]));for(let o of e){if(i.has(o))throw Error("One or more selected slots are already booked or locked.");let e=new Date(o);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected for locking.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let a=e.getUTCHours();if(a<7||a>=22)throw Error("Slot is outside of bookable hours.");let s=new Date(e);s.setUTCMinutes(e.getUTCMinutes()+30);let u={id:o,start:e.toISOString(),end:s.toISOString(),bookedByName:r||"Admin Hold",bookedByEmail:"admin@englishwithdaniel.com",bookingType:t?.trim()||void 0,bookedAt:new Date().toISOString(),entryType:"admin-lock"};n.push(u),i.set(o,u)}await h(n)}async function D(e){if(!e.length)throw Error("No slot ids provided for unlocking.");let t=await g(),r=new Set(e),n=t.filter(e=>!("admin-lock"===e.entryType&&r.has(e.id)));await h(n)}async function U(){return k()}async function x(e){let{weekday:t,startMinutes:r,durationMinutes:n,note:i}=e;if(!Number.isInteger(t)||t<0||t>6)throw Error("Weekday must be between 0 (Sunday) and 6 (Saturday).");if(r%30!=0)throw Error("Start time must align with the 30-minute grid.");if(n<30||n%30!=0)throw Error("Duration must be in 30-minute increments.");if(r<420||r>=1320)throw Error("Start time is outside of bookable hours.");if(r+n>1320)throw Error("Recurring lock exceeds the bookable day range.");let o=await k(),a={id:`${t}-${r}-${Date.now()}`,weekday:t,startMinutes:r,durationMinutes:n,note:i?.trim()||void 0};return o.push(a),await S(o),o}async function M(e){let t=(await k()).filter(t=>t.id!==e);return await S(t),t}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,786,972],()=>r(7238));module.exports=n})();