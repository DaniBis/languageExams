"use strict";(()=>{var e={};e.id=228,e.ids=[228],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},7238:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>g,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>c});var o={};r.r(o),r.d(o,{GET:()=>u});var n=r(9303),i=r(8716),a=r(670),s=r(7070),l=r(8827);async function u(){try{let e=await (0,l.aL)(),t=Date.now(),r=e.filter(e=>"admin-lock"!==e.entryType).filter(e=>new Date(e.start).getTime()>t).sort((e,t)=>new Date(e.start).getTime()-new Date(t.start).getTime())[0];if(!r)return s.NextResponse.json({nextLesson:null});return s.NextResponse.json({nextLesson:{start:r.start,end:r.end,studentName:r.bookedByName,bookingType:r.bookingType||null}})}catch(e){return console.error("Failed to load next lesson",e),s.NextResponse.json({error:"Failed to load next lesson"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/next-lesson/route",pathname:"/api/next-lesson",filename:"route",bundlePath:"app/api/next-lesson/route"},resolvedPagePath:"/Users/ovidiuban/languageExams/app/api/next-lesson/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:c,serverHooks:m}=d,w="/api/next-lesson/route";function g(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:c})}},8827:(e,t,r)=>{r.d(t,{C9:()=>d,CB:()=>c,Yj:()=>m,aL:()=>p,hy:()=>w});var o=r(2048),n=r(5315),i=r.n(n);let a=i().join(process.cwd(),"data","schedule.json");async function s(){await o.promises.mkdir(i().dirname(a),{recursive:!0});try{await o.promises.access(a)}catch{await o.promises.writeFile(a,"[]","utf8")}}async function l(){await s();let e=await o.promises.readFile(a,"utf8"),t=e.trim()?JSON.parse(e):[];return Array.isArray(t)?t.map(e=>({...e,entryType:"admin-lock"===e.entryType?"admin-lock":"user"})):[]}async function u(e){await s(),await o.promises.writeFile(a,JSON.stringify(e,null,2),"utf8")}async function d({startDate:e,days:t}={}){let r=new Map((await l()).map(e=>[e.id,e])),o=e?new Date(e):new Date;return Number.isNaN(o.getTime())&&(o=new Date),(function(e,t){let r=[];for(let o=0;o<t;o++){let t=new Date(e);t.setUTCDate(e.getUTCDate()+o);for(let e=7;e<22;e++)for(let o=0;o<60;o+=30){let n=new Date(t);n.setUTCHours(e,o,0,0);let i=new Date(n);i.setUTCMinutes(n.getUTCMinutes()+30),r.push({id:n.toISOString(),start:n.toISOString(),end:i.toISOString(),status:"available"})}}return r})(function(e){let t=new Date(e);return t.setUTCHours(0,0,0,0),t}(o),Math.min(Math.max(t??7,1),31)).map(e=>{let t=r.get(e.id);if(!t)return e;let o="admin-lock"===t.entryType?"locked":"booked";return{...e,status:o}})}async function p(){return l()}async function c(e,{name:t,email:r,note:o,bookingType:n}){if(!e.length)throw Error("No slot ids provided.");let i=await l(),a=new Map(i.map(e=>[e.id,e])),s=[];for(let l of e){if(a.has(l))throw Error("One or more slots have just been booked by another student.");let e=new Date(l);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let u=e.getUTCHours();if(u<7||u>=22)throw Error("Slot is outside of bookable hours.");let d=new Date(e);d.setUTCMinutes(e.getUTCMinutes()+30);let p={id:l,start:e.toISOString(),end:d.toISOString(),bookedByName:t,bookedByEmail:r,bookingType:n?.trim()||void 0,note:o,bookedAt:new Date().toISOString(),entryType:"user"};i.push(p),a.set(l,p),s.push({id:l,start:p.start,end:p.end,status:"booked"})}return await u(i),s}async function m(e,{note:t,adminLabel:r}={}){if(!e.length)throw Error("No slot ids provided for locking.");let o=await l(),n=new Map(o.map(e=>[e.id,e]));for(let i of e){if(n.has(i))throw Error("One or more selected slots are already booked or locked.");let e=new Date(i);if(Number.isNaN(e.getTime()))throw Error("Invalid slot selected for locking.");if(e.getUTCMinutes()%30!=0)throw Error("Slot is not aligned to the 30-minute grid.");let a=e.getUTCHours();if(a<7||a>=22)throw Error("Slot is outside of bookable hours.");let s=new Date(e);s.setUTCMinutes(e.getUTCMinutes()+30);let l={id:i,start:e.toISOString(),end:s.toISOString(),bookedByName:r||"Admin Hold",bookedByEmail:"admin@englishwithdaniel.com",bookingType:t?.trim()||void 0,bookedAt:new Date().toISOString(),entryType:"admin-lock"};o.push(l),n.set(i,l)}await u(o)}async function w(e){if(!e.length)throw Error("No slot ids provided for unlocking.");let t=await l(),r=new Set(e),o=t.filter(e=>!("admin-lock"===e.entryType&&r.has(e.id)));await u(o)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[276,972],()=>r(7238));module.exports=o})();